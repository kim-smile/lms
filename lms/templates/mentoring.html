{% extends "base.html" %}
{% block title %}멘토링 · LMS{% endblock %}

{% block content %}
  <h1 class="page-title">멘토링 허브</h1>
  <p class="subtitle">보고서, 팀, 프로젝트, 공모전, GitHub 연동을 한 곳에서 관리하세요.</p>

  <!-- Tabs -->
  <nav class="tabs" aria-label="멘토링 탭">
    <a class="tab {{ 'active' if tab == 'reports' else '' }}" href="{{ url_for('mentoring.home', tab='reports') }}">보고서</a>
    <a class="tab {{ 'active' if tab == 'teams' else '' }}" href="{{ url_for('mentoring.home', tab='teams') }}">팀원 관리</a>
    <a class="tab {{ 'active' if tab == 'projects' else '' }}" href="{{ url_for('mentoring.home', tab='projects') }}">프로젝트/작업</a>
    <a class="tab {{ 'active' if tab == 'competitions' else '' }}" href="{{ url_for('mentoring.home', tab='competitions') }}">공모전</a>
    <a class="tab {{ 'active' if tab == 'github' else '' }}" href="{{ url_for('mentoring.home', tab='github') }}">GitHub 연동</a>
  </nav>

  <!-- Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# -------------------- Reports -------------------- #}
  {% if tab == 'reports' %}
    <div class="grid grid-2">
      <!-- 새 보고서 -->
      <section class="card">
        <div class="card-title">새 보고서</div>
        <form method="post" action="{{ url_for('mentoring.report_new') }}" enctype="multipart/form-data">
          <div class="row">
            <label for="r-title">제목</label>
            <input id="r-title" name="title" required>
          </div>
          <div class="row">
            <label for="r-content">내용</label>
            <textarea id="r-content" name="content" rows="5"></textarea>
          </div>
          <div class="row">
            <label for="r-team">팀(선택)</label>
            <select id="r-team" name="team_id">
              <option value="">개인</option>
              {% for t in my_teams %}
                <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <label for="r-file">파일</label>
            <input id="r-file" type="file" name="file">
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">등록</button>
          </div>
        </form>
      </section>

      <!-- 내 보고서 -->
      <section class="card">
        <div class="card-title">내 보고서</div>
        <ul class="list">
          {% for r in my_reports %}
            <li>
              <b>{{ r.title }}</b>
              <span class="muted"> · {{ r.created_at|dt_kr }}</span>
              {% if r.team %}<span class="muted"> · 팀: {{ r.team.name }}</span>{% endif %}
              {% if r.file_url %} · <a href="{{ r.file_url }}" target="_blank" rel="noopener">첨부</a>{% endif %}
              <div class="muted">
                {{ (r.content or '')[:120] }}{% if r.content and r.content|length > 120 %}…{% endif %}
              </div>
            </li>
          {% else %}
            <li class="muted">보고서가 없습니다.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

  {# -------------------- Teams -------------------- #}
  {% elif tab == 'teams' %}
    <div class="grid grid-2">
      <!-- 팀 생성 -->
      <section class="card">
        <div class="card-title">팀 생성</div>
        <form method="post" action="{{ url_for('mentoring.team_new') }}">
          <div class="row">
            <label for="t-name">팀 이름</label>
            <input id="t-name" name="name" required>
          </div>
          <div class="row">
            <label for="t-solo">개인 단독 팀</label>
            <input id="t-solo" type="checkbox" name="is_solo">
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">생성</button>
          </div>
        </form>
      </section>

      <!-- 팀 참여/목록 -->
      <section class="card">
        <div class="card-title">팀 참여</div>
        <form method="post" action="{{ url_for('mentoring.team_join') }}">
          <div class="row">
            <label for="tj-id">팀 ID</label>
            <input id="tj-id" name="team_id" placeholder="예: 3" required>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">참여</button>
          </div>
        </form>

        <div class="card-title" style="margin-top:.5rem">내 팀</div>
        <ul class="list">
          {% for t in my_teams %}
            <li>#{{ t.id }} · <b>{{ t.name }}</b>{% if t.is_solo %} <span class="muted">(개인)</span>{% endif %}</li>
          {% else %}
            <li class="muted">참여한 팀이 없습니다.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

  {# -------------------- Projects -------------------- #}
  {% elif tab == 'projects' %}
    <!-- 새 프로젝트 -->
    <section class="card">
      <div class="card-title">새 프로젝트</div>
      <form method="post" action="{{ url_for('mentoring.project_new') }}">
        <div class="row">
          <label for="p-title">제목</label>
          <input id="p-title" name="title" required>
        </div>
        <div class="row">
          <label for="p-desc">설명</label>
          <textarea id="p-desc" name="description" rows="4"></textarea>
        </div>
        <div class="row">
          <label for="p-team">팀(선택)</label>
          <select id="p-team" name="team_id">
            <option value="">개인 프로젝트</option>
            {% for t in my_teams %}
              <option value="{{ t.id }}">{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row">
          <label for="p-github">GitHub</label>
          <input id="p-github" name="github" placeholder="https://github.com/org/repo">
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">생성</button>
        </div>
      </form>
    </section>

    <!-- 프로젝트 목록 -->
    <div class="grid grid-2">
      {% for p in my_projects %}
        <section class="card">
          <div class="row">
            <b>{{ p.title }}</b>
            <span class="muted">{{ p.status }}</span>
          </div>
          <div class="muted">
            {{ (p.description or '')[:140] }}{% if p.description and p.description|length > 140 %}…{% endif %}
          </div>
          {% if p.github_repo_url %}
            <div class="kv">🔗 <a href="{{ p.github_repo_url }}" target="_blank" rel="noopener">{{ p.github_repo_url }}</a></div>
          {% endif %}

          <div class="card-title">작업 추가</div>
          <form method="post" action="{{ url_for('mentoring.task_new') }}">
            <input type="hidden" name="project_id" value="{{ p.id }}">
            <div class="row">
              <label for="t-title-{{ p.id }}">제목</label>
              <input id="t-title-{{ p.id }}" name="title" required>
            </div>
            <div class="row">
              <label for="t-due-{{ p.id }}">마감</label>
              <input id="t-due-{{ p.id }}" name="due_at" placeholder="YYYY-MM-DD HH:MM">
            </div>
            <div class="row">
              <label for="t-asg-{{ p.id }}">담당자ID</label>
              <input id="t-asg-{{ p.id }}" name="assignee_id" placeholder="선택">
            </div>
            <div class="actions">
              <button class="btn" type="submit">추가</button>
            </div>
          </form>

          <div class="card-title">작업 목록</div>
          <ul class="list">
            {% for t in p.tasks %}
              <li>
                • {{ t.title }}
                <span class="muted">
                  {% if t.due_at %} · {{ t.due_at|dt_kr }}{% endif %}
                  {% if t.assignee %} · 담당: {{ t.assignee.name }}{% endif %}
                  · {{ t.status }}
                </span>
              </li>
            {% else %}
              <li class="muted">작업이 없습니다.</li>
            {% endfor %}
          </ul>
        </section>
      {% else %}
        <section class="card"><div class="muted">프로젝트가 없습니다.</div></section>
      {% endfor %}
    </div>

  {# -------------------- Competitions -------------------- #}
  {% elif tab == 'competitions' %}
    <div class="grid grid-2">
      <!-- 공모전 등록 -->
      <section class="card">
        <div class="card-title">공모전 등록(관리/교수용)</div>
        <form method="post" action="{{ url_for('mentoring.comp_new') }}">
          <div class="row">
            <label for="c-title">제목</label>
            <input id="c-title" name="title" required>
          </div>
          <div class="row">
            <label for="c-host">주최</label>
            <input id="c-host" name="host">
          </div>
          <div class="row">
            <label for="c-url">URL</label>
            <input id="c-url" name="url" placeholder="https://…">
          </div>
          <div class="row">
            <label for="c-deadline">마감</label>
            <input id="c-deadline" name="apply_deadline" placeholder="YYYY-MM-DD HH:MM">
          </div>
          <div class="actions">
            <button class="btn" type="submit">등록</button>
          </div>
        </form>
      </section>

      <!-- 공모전 신청 -->
      <section class="card">
        <div class="card-title">공모전 신청</div>
        <form method="post" action="{{ url_for('mentoring.comp_apply') }}">
          <div class="row">
            <label for="a-comp">공모전</label>
            <select id="a-comp" name="competition_id" required>
              {% for c in comps %}
                <option value="{{ c.id }}">
                  {{ c.title }}{% if c.apply_deadline %} · 마감 {{ c.apply_deadline|dt_kr }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <label for="a-team">팀(선택)</label>
            <select id="a-team" name="team_id">
              <option value="">개인 신청</option>
              {% for t in my_teams %}
                <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <label for="a-proj">프로젝트(선택)</label>
            <select id="a-proj" name="project_id">
              <option value="">미지정</option>
              {% for p in my_projects %}
                <option value="{{ p.id }}">{{ p.title }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">신청</button>
          </div>
        </form>

        <div class="card-title">내 신청 내역</div>
        <ul class="list">
          {% for e in my_entries %}
            <li>#{{ e.id }} · {{ e.competition.title }} <span class="muted">· {{ e.status }}</span></li>
          {% else %}
            <li class="muted">신청 내역이 없습니다.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

  {# -------------------- GitHub -------------------- #}
  {% else %}
    <section class="card">
      <div class="card-title">GitHub 연동</div>
      <p class="muted">
        프로젝트에 레포지토리 URL을 저장/공유합니다. 향후 Webhook·이슈 동기화 등으로 확장할 수 있습니다.
        프로젝트 생성 또는 편집 시 <b>GitHub URL</b>을 입력하세요.
      </p>
      <ul class="list">
        {% for p in my_projects if p.github_repo_url %}
          <li><b>{{ p.title }}</b> — <a href="{{ p.github_repo_url }}" target="_blank" rel="noopener">{{ p.github_repo_url }}</a></li>
        {% else %}
          <li class="muted">연동된 레포가 없습니다. 프로젝트 생성 시 GitHub URL을 넣어보세요.</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endblock %}