{% extends "base.html" %}
{% block title %}멘토링{% endblock %}
{% block header %}멘토링 허브{% endblock %}

{% block content %}
<div class="tabs">
  <a class="tab {{ 'active' if tab=='reports' }}" href="?tab=reports">보고서</a>
  <a class="tab {{ 'active' if tab=='teams' }}" href="?tab=teams">팀원 관리</a>
  <a class="tab {{ 'active' if tab=='projects' }}" href="?tab=projects">프로젝트/작업</a>
  <a class="tab {{ 'active' if tab=='competitions' }}" href="?tab=competitions">공모전</a>
  <a class="tab {{ 'active' if tab=='github' }}" href="?tab=github">GitHub 연동</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="flash {{ category }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if tab == 'reports' %}
  <div class="grid2">
    <div class="card">
      <div class="title">새 보고서</div>
      <form method="post" action="{{ url_for('mentoring_report_new') }}" enctype="multipart/form-data">
        <div class="row"><label>제목</label><input name="title" required></div>
        <div class="row"><label>내용</label><textarea name="content" rows="5"></textarea></div>
        <div class="row">
          <label>팀(선택)</label>
          <select name="team_id">
            <option value="">개인</option>
            {% for t in my_teams %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="row"><label>파일</label><input type="file" name="file"></div>
        <div class="actions"><button class="btn primary">등록</button></div>
      </form>
    </div>
    <div class="card">
      <div class="title">내 보고서</div>
      <ul class="list">
        {% for r in my_reports %}
        <li>
          <b>{{ r.title }}</b>
          <span class="muted"> · {{ r.created_at|dt_kr }}</span>
          {% if r.team %}<span class="muted"> · 팀: {{ r.team.name }}</span>{% endif %}
          {% if r.file_url %} · <a href="{{ r.file_url }}" target="_blank">첨부</a>{% endif %}
          <div class="muted">{{ (r.content or '')[:120] }}{% if r.content and r.content|length>120 %}…{% endif %}</div>
        </li>
        {% else %}
        <li class="muted">보고서가 없습니다.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

{% elif tab == 'teams' %}
  <div class="grid2">
    <div class="card">
      <div class="title">팀 생성</div>
      <form method="post" action="{{ url_for('mentoring_team_new') }}">
        <div class="row"><label>팀 이름</label><input name="name" required></div>
        <div class="row"><label></label><label><input type="checkbox" name="is_solo"> 개인 단독 팀</label></div>
        <div class="actions"><button class="btn primary">생성</button></div>
      </form>
    </div>
    <div class="card">
      <div class="title">팀 참여</div>
      <form method="post" action="{{ url_for('mentoring_team_join') }}">
        <div class="row"><label>팀 ID</label><input name="team_id" placeholder="예: 3" required></div>
        <div class="actions"><button class="btn primary">참여</button></div>
      </form>
      <hr>
      <div class="title">내 팀</div>
      <ul class="list">
        {% for t in my_teams %}
          <li>#{{ t.id }} · <b>{{ t.name }}</b>{% if t.is_solo %} <span class="muted">(개인)</span>{% endif %}</li>
        {% else %}
          <li class="muted">참여한 팀이 없습니다.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

{% elif tab == 'projects' %}
  <div class="card">
    <div class="title">새 프로젝트</div>
    <form method="post" action="{{ url_for('mentoring_project_new') }}">
      <div class="row"><label>제목</label><input name="title" required></div>
      <div class="row"><label>설명</label><textarea name="description" rows="4"></textarea></div>
      <div class="row">
        <label>팀(선택)</label>
        <select name="team_id">
          <option value="">개인 프로젝트</option>
          {% for t in my_teams %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="row"><label>GitHub</label><input name="github" placeholder="https://github.com/org/repo"></div>
      <div class="actions"><button class="btn primary">생성</button></div>
    </form>
  </div>

  <div class="grid2">
    {% for p in my_projects %}
    <div class="card">
      <div class="row">
        <b>{{ p.title }}</b>
        <span class="muted">{{ p.status }}</span>
      </div>
      <div class="muted">{{ (p.description or '')[:140] }}{% if p.description and p.description|length>140 %}…{% endif %}</div>
      {% if p.github_repo_url %}<div class="kv">🔗 <a href="{{ p.github_repo_url }}" target="_blank">{{ p.github_repo_url }}</a></div>{% endif %}
      <div class="title" style="margin-top:10px;">작업 추가</div>
      <form method="post" action="{{ url_for('mentoring_task_new') }}">
        <input type="hidden" name="project_id" value="{{ p.id }}">
        <div class="row"><label>제목</label><input name="title" required></div>
        <div class="row"><label>마감</label><input name="due_at" placeholder="YYYY-MM-DD HH:MM"></div>
        <div class="row"><label>담당자ID</label><input name="assignee_id" placeholder="선택"></div>
        <div class="actions"><button class="btn">추가</button></div>
      </form>
      <div class="title" style="margin-top:8px;">작업 목록</div>
      <ul class="list">
        {% for t in p.tasks %}
          <li>• {{ t.title }} <span class="muted">
            {% if t.due_at %} · {{ t.due_at|dt_kr }}{% endif %}
            {% if t.assignee %} · 담당: {{ t.assignee.name }}{% endif %}
            · {{ t.status }}
          </span></li>
        {% else %}
          <li class="muted">작업이 없습니다.</li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
      <div class="muted">프로젝트가 없습니다.</div>
    {% endfor %}
  </div>

{% elif tab == 'competitions' %}
  <div class="grid2">
    <div class="card">
      <div class="title">공모전 등록(관리/교수용)</div>
      <form method="post" action="{{ url_for('mentoring_comp_new') }}">
        <div class="row"><label>제목</label><input name="title" required></div>
        <div class="row"><label>주최</label><input name="host"></div>
        <div class="row"><label>URL</label><input name="url"></div>
        <div class="row"><label>마감</label><input name="apply_deadline" placeholder="YYYY-MM-DD HH:MM"></div>
        <div class="actions"><button class="btn">등록</button></div>
      </form>
    </div>
    <div class="card">
      <div class="title">공모전 신청</div>
      <form method="post" action="{{ url_for('mentoring_comp_apply') }}">
        <div class="row">
          <label>공모전</label>
          <select name="competition_id" required>
            {% for c in comps %}
              <option value="{{ c.id }}">{{ c.title }}{% if c.apply_deadline %} · 마감 {{ c.apply_deadline|dt_kr }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row">
          <label>팀(선택)</label>
          <select name="team_id">
            <option value="">개인 신청</option>
            {% for t in my_teams %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="row">
          <label>프로젝트(선택)</label>
          <select name="project_id">
            <option value="">미지정</option>
            {% for p in my_projects %}<option value="{{ p.id }}">{{ p.title }}</option>{% endfor %}
          </select>
        </div>
        <div class="actions"><button class="btn primary">신청</button></div>
      </form>
      <div class="title" style="margin-top:12px;">내 신청 내역</div>
      <ul class="list">
        {% for e in my_entries %}
          <li>#{{ e.id }} · {{ e.competition.title }} <span class="muted">· {{ e.status }}</span></li>
        {% else %}
          <li class="muted">신청 내역이 없습니다.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

{% else %} {# github #}
  <div class="card">
    <div class="title">GitHub 연동</div>
    <p class="muted">
      간단히 <b>프로젝트에 레포지토리 URL</b>을 저장/공유합니다. 향후 Webhook·이슈 동기화까지 확장 가능.
      프로젝트 탭에서 각 프로젝트의 <i>GitHub</i> URL을 입력하면 됩니다.
    </p>
    <ul class="list">
      {% for p in my_projects if p.github_repo_url %}
        <li><b>{{ p.title }}</b> — <a href="{{ p.github_repo_url }}" target="_blank">{{ p.github_repo_url }}</a></li>
      {% else %}
        <li class="muted">연동된 레포가 없습니다. 프로젝트 생성 시 GitHub URL을 넣어보세요.</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
{% endblock %}