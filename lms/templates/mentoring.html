{% extends "base.html" %}
{% block title %}ë©˜í† ë§ Â· LMS{% endblock %}

{% block content %}
  <h1 class="page-title">ë©˜í† ë§ í—ˆë¸Œ</h1>
  <p class="subtitle">ë³´ê³ ì„œ, íŒ€, í”„ë¡œì íŠ¸, ê³µëª¨ì „, GitHub ì—°ë™ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”.</p>

  <!-- Tabs -->
  <nav class="tabs" aria-label="ë©˜í† ë§ íƒ­">
    <a class="tab {{ 'active' if tab == 'reports' else '' }}" href="{{ url_for('mentoring.home', tab='reports') }}">ë³´ê³ ì„œ</a>
    <a class="tab {{ 'active' if tab == 'teams' else '' }}" href="{{ url_for('mentoring.home', tab='teams') }}">íŒ€ì› ê´€ë¦¬</a>
    <a class="tab {{ 'active' if tab == 'projects' else '' }}" href="{{ url_for('mentoring.home', tab='projects') }}">í”„ë¡œì íŠ¸/ì‘ì—…</a>
    <a class="tab {{ 'active' if tab == 'competitions' else '' }}" href="{{ url_for('mentoring.home', tab='competitions') }}">ê³µëª¨ì „</a>
    <a class="tab {{ 'active' if tab == 'github' else '' }}" href="{{ url_for('mentoring.home', tab='github') }}">GitHub ì—°ë™</a>
  </nav>

  <!-- Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# -------------------- Reports -------------------- #}
  {% if tab == 'reports' %}
    <div class="grid grid-2">
      <!-- ìƒˆ ë³´ê³ ì„œ -->
      <section class="card">
        <div class="card-title">ìƒˆ ë³´ê³ ì„œ</div>
        <form method="post" action="{{ url_for('mentoring.report_new') }}" enctype="multipart/form-data">
          <div class="row">
            <label for="r-title">ì œëª©</label>
            <input id="r-title" name="title" required>
          </div>
          <div class="row">
            <label for="r-content">ë‚´ìš©</label>
            <textarea id="r-content" name="content" rows="5"></textarea>
          </div>
          <div class="row">
            <label for="r-team">íŒ€(ì„ íƒ)</label>
            <select id="r-team" name="team_id">
              <option value="">ê°œì¸</option>
              {% for t in my_teams %}
                <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <label for="r-file">íŒŒì¼</label>
            <input id="r-file" type="file" name="file">
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">ë“±ë¡</button>
          </div>
        </form>
      </section>

      <!-- ë‚´ ë³´ê³ ì„œ -->
      <section class="card">
        <div class="card-title">ë‚´ ë³´ê³ ì„œ</div>
        <ul class="list">
          {% for r in my_reports %}
            <li>
              <b>{{ r.title }}</b>
              <span class="muted"> Â· {{ r.created_at|dt_kr }}</span>
              {% if r.team %}<span class="muted"> Â· íŒ€: {{ r.team.name }}</span>{% endif %}
              {% if r.file_url %} Â· <a href="{{ r.file_url }}" target="_blank" rel="noopener">ì²¨ë¶€</a>{% endif %}
              <div class="muted">
                {{ (r.content or '')[:120] }}{% if r.content and r.content|length > 120 %}â€¦{% endif %}
              </div>
            </li>
          {% else %}
            <li class="muted">ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

  {# -------------------- Teams -------------------- #}
  {% elif tab == 'teams' %}
    <div class="grid grid-2">
      <!-- íŒ€ ìƒì„± -->
      <section class="card">
        <div class="card-title">íŒ€ ìƒì„±</div>
        <form method="post" action="{{ url_for('mentoring.team_new') }}">
          <div class="row">
            <label for="t-name">íŒ€ ì´ë¦„</label>
            <input id="t-name" name="name" required>
          </div>
          <div class="row">
            <label for="t-solo">ê°œì¸ ë‹¨ë… íŒ€</label>
            <input id="t-solo" type="checkbox" name="is_solo">
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">ìƒì„±</button>
          </div>
        </form>
      </section>

      <!-- íŒ€ ì°¸ì—¬/ëª©ë¡ -->
      <section class="card">
        <div class="card-title">íŒ€ ì°¸ì—¬</div>
        <form method="post" action="{{ url_for('mentoring.team_join') }}">
          <div class="row">
            <label for="tj-id">íŒ€ ID</label>
            <input id="tj-id" name="team_id" placeholder="ì˜ˆ: 3" required>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">ì°¸ì—¬</button>
          </div>
        </form>

        <div class="card-title" style="margin-top:.5rem">ë‚´ íŒ€</div>
        <ul class="list">
          {% for t in my_teams %}
            <li>#{{ t.id }} Â· <b>{{ t.name }}</b>{% if t.is_solo %} <span class="muted">(ê°œì¸)</span>{% endif %}</li>
          {% else %}
            <li class="muted">ì°¸ì—¬í•œ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

  {# -------------------- Projects -------------------- #}
  {% elif tab == 'projects' %}
    <!-- ìƒˆ í”„ë¡œì íŠ¸ -->
    <section class="card">
      <div class="card-title">ìƒˆ í”„ë¡œì íŠ¸</div>
      <form method="post" action="{{ url_for('mentoring.project_new') }}">
        <div class="row">
          <label for="p-title">ì œëª©</label>
          <input id="p-title" name="title" required>
        </div>
        <div class="row">
          <label for="p-desc">ì„¤ëª…</label>
          <textarea id="p-desc" name="description" rows="4"></textarea>
        </div>
        <div class="row">
          <label for="p-team">íŒ€(ì„ íƒ)</label>
          <select id="p-team" name="team_id">
            <option value="">ê°œì¸ í”„ë¡œì íŠ¸</option>
            {% for t in my_teams %}
              <option value="{{ t.id }}">{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row">
          <label for="p-github">GitHub</label>
          <input id="p-github" name="github" placeholder="https://github.com/org/repo">
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">ìƒì„±</button>
        </div>
      </form>
    </section>

    <!-- í”„ë¡œì íŠ¸ ëª©ë¡ -->
    <div class="grid grid-2">
      {% for p in my_projects %}
        <section class="card">
          <div class="row">
            <b>{{ p.title }}</b>
            <span class="muted">{{ p.status }}</span>
          </div>
          <div class="muted">
            {{ (p.description or '')[:140] }}{% if p.description and p.description|length > 140 %}â€¦{% endif %}
          </div>
          {% if p.github_repo_url %}
            <div class="kv">ğŸ”— <a href="{{ p.github_repo_url }}" target="_blank" rel="noopener">{{ p.github_repo_url }}</a></div>
          {% endif %}

          <div class="card-title">ì‘ì—… ì¶”ê°€</div>
          <form method="post" action="{{ url_for('mentoring.task_new') }}">
            <input type="hidden" name="project_id" value="{{ p.id }}">
            <div class="row">
              <label for="t-title-{{ p.id }}">ì œëª©</label>
              <input id="t-title-{{ p.id }}" name="title" required>
            </div>
            <div class="row">
              <label for="t-due-{{ p.id }}">ë§ˆê°</label>
              <input id="t-due-{{ p.id }}" name="due_at" placeholder="YYYY-MM-DD HH:MM">
            </div>
            <div class="row">
              <label for="t-asg-{{ p.id }}">ë‹´ë‹¹ìID</label>
              <input id="t-asg-{{ p.id }}" name="assignee_id" placeholder="ì„ íƒ">
            </div>
            <div class="actions">
              <button class="btn" type="submit">ì¶”ê°€</button>
            </div>
          </form>

          <div class="card-title">ì‘ì—… ëª©ë¡</div>
          <ul class="list">
            {% for t in p.tasks %}
              <li>
                â€¢ {{ t.title }}
                <span class="muted">
                  {% if t.due_at %} Â· {{ t.due_at|dt_kr }}{% endif %}
                  {% if t.assignee %} Â· ë‹´ë‹¹: {{ t.assignee.name }}{% endif %}
                  Â· {{ t.status }}
                </span>
              </li>
            {% else %}
              <li class="muted">ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            {% endfor %}
          </ul>
        </section>
      {% else %}
        <section class="card"><div class="muted">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div></section>
      {% endfor %}
    </div>

  {# -------------------- Competitions -------------------- #}
  {% elif tab == 'competitions' %}
    <div class="grid grid-2">
      <!-- ê³µëª¨ì „ ë“±ë¡ -->
      <section class="card">
        <div class="card-title">ê³µëª¨ì „ ë“±ë¡(ê´€ë¦¬/êµìˆ˜ìš©)</div>
        <form method="post" action="{{ url_for('mentoring.comp_new') }}">
          <div class="row">
            <label for="c-title">ì œëª©</label>
            <input id="c-title" name="title" required>
          </div>
          <div class="row">
            <label for="c-host">ì£¼ìµœ</label>
            <input id="c-host" name="host">
          </div>
          <div class="row">
            <label for="c-url">URL</label>
            <input id="c-url" name="url" placeholder="https://â€¦">
          </div>
          <div class="row">
            <label for="c-deadline">ë§ˆê°</label>
            <input id="c-deadline" name="apply_deadline" placeholder="YYYY-MM-DD HH:MM">
          </div>
          <div class="actions">
            <button class="btn" type="submit">ë“±ë¡</button>
          </div>
        </form>
      </section>

      <!-- ê³µëª¨ì „ ì‹ ì²­ -->
      <section class="card">
        <div class="card-title">ê³µëª¨ì „ ì‹ ì²­</div>
        <form method="post" action="{{ url_for('mentoring.comp_apply') }}">
          <div class="row">
            <label for="a-comp">ê³µëª¨ì „</label>
            <select id="a-comp" name="competition_id" required>
              {% for c in comps %}
                <option value="{{ c.id }}">
                  {{ c.title }}{% if c.apply_deadline %} Â· ë§ˆê° {{ c.apply_deadline|dt_kr }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <label for="a-team">íŒ€(ì„ íƒ)</label>
            <select id="a-team" name="team_id">
              <option value="">ê°œì¸ ì‹ ì²­</option>
              {% for t in my_teams %}
                <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row">
            <label for="a-proj">í”„ë¡œì íŠ¸(ì„ íƒ)</label>
            <select id="a-proj" name="project_id">
              <option value="">ë¯¸ì§€ì •</option>
              {% for p in my_projects %}
                <option value="{{ p.id }}">{{ p.title }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="actions">
            <button class="btn primary" type="submit">ì‹ ì²­</button>
          </div>
        </form>

        <div class="card-title">ë‚´ ì‹ ì²­ ë‚´ì—­</div>
        <ul class="list">
          {% for e in my_entries %}
            <li>#{{ e.id }} Â· {{ e.competition.title }} <span class="muted">Â· {{ e.status }}</span></li>
          {% else %}
            <li class="muted">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

  {# -------------------- GitHub -------------------- #}
  {% else %}
    <section class="card">
      <div class="card-title">GitHub ì—°ë™</div>
      <p class="muted">
        í”„ë¡œì íŠ¸ì— ë ˆí¬ì§€í† ë¦¬ URLì„ ì €ì¥/ê³µìœ í•©ë‹ˆë‹¤. í–¥í›„ WebhookÂ·ì´ìŠˆ ë™ê¸°í™” ë“±ìœ¼ë¡œ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        í”„ë¡œì íŠ¸ ìƒì„± ë˜ëŠ” í¸ì§‘ ì‹œ <b>GitHub URL</b>ì„ ì…ë ¥í•˜ì„¸ìš”.
      </p>
      <ul class="list">
        {% for p in my_projects if p.github_repo_url %}
          <li><b>{{ p.title }}</b> â€” <a href="{{ p.github_repo_url }}" target="_blank" rel="noopener">{{ p.github_repo_url }}</a></li>
        {% else %}
          <li class="muted">ì—°ë™ëœ ë ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ìƒì„± ì‹œ GitHub URLì„ ë„£ì–´ë³´ì„¸ìš”.</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endblock %}