{% extends "base.html" %}
{% block title %}í”„ë¡œí•„ Â· LMS{% endblock %}

{% block content %}
<h1 class="page-title">í”„ë¡œí•„</h1>
<p class="subtitle">ë‚´ ì •ë³´ì™€ í†µê³„ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.</p>

<div class="grid-profile">
  <!-- ì¢Œì¸¡: í”„ë¡œí•„ ì¹´ë“œ -->
  <aside class="card" aria-labelledby="profile-card-title">
    <h2 class="card-title" id="profile-card-title" style="margin-bottom:.5rem;">ë‚´ í”„ë¡œí•„</h2>

    <div class="profile-hero" aria-label="ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´">
      <div class="avatar">{{ (user.name or '?')|list|first }}</div>
      <div class="name">{{ user.name or 'ì´ë¦„ì—†ìŒ' }}</div>
      <div class="handle">@{{ user.username or ('user' ~ user.id) }}</div>
      <div class="role-chip">{{ user.role or 'student' }}</div>
    </div>

    <div class="kv" aria-label="ì´ë©”ì¼"><span>ğŸ“§</span><span>{{ user.email }}</span></div>
    {% if user.phone %}
    <div class="kv" aria-label="ì „í™”ë²ˆí˜¸"><span>ğŸ“±</span><span>{{ user.phone }}</span></div>
    {% endif %}
    <div class="kv" aria-label="ê°€ì…ì¼"><span>ğŸ—“ï¸</span><span>ê°€ì…ì¼: {{ user.created_at|ymd_kr }}</span></div>

    <div class="stats">
      <div>ìˆ˜ê°• ì¤‘ì¸ ê°•ì¢Œ <b>{{ enrolled_cnt }}</b> ê°œ</div>
      <div>ì™„ë£Œí•œ ê³¼ì œ <b>{{ submitted_cnt }}</b> ê°œ</div>
      <div>í‰ê·  ì ìˆ˜ <b>{{ avg_score if avg_score is not none else '-' }}</b></div>
    </div>
  </aside>

  <!-- ìš°ì¸¡: ìƒì„¸/í¸ì§‘ -->
  <section class="card">
    <div class="tabs" role="tablist" aria-label="í”„ë¡œí•„ íƒ­">
      <button class="tab active" data-tab="basic" role="tab" aria-selected="true">ê¸°ë³¸ ì •ë³´</button>
      <button class="tab" data-tab="security" role="tab" aria-selected="false">ë³´ì•ˆ</button>
      <button class="tab" data-tab="prefs" role="tab" aria-selected="false">í™˜ê²½ì„¤ì •</button>
      <div class="spacer" style="flex:1"></div>
      <button id="btnEdit" class="btn" type="button">í¸ì§‘</button>
    </div>

    <div class="pad">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="formBasic" method="post" action="{{ url_for('profile.update') }}">
        <div data-pane="basic">
          <div class="row">
            <label for="f-name">ì´ë¦„</label>
            <input id="f-name" name="name" value="{{ user.name or '' }}" readonly>
          </div>
          <div class="row">
            <label for="f-email">ì´ë©”ì¼</label>
            <input id="f-email" name="email" type="email" value="{{ user.email or '' }}" readonly>
          </div>
          <div class="row">
            <label for="f-phone">ì „í™”ë²ˆí˜¸</label>
            <input id="f-phone" name="phone" value="{{ user.phone or '' }}" placeholder="010-0000-0000" readonly>
          </div>
          <div class="row">
            <label for="f-username">ì‚¬ìš©ìëª…(í•¸ë“¤)</label>
            <input id="f-username" name="username" value="{{ user.username or '' }}" placeholder="ì˜ˆ: @young" readonly>
          </div>

          <div class="actions">
            <button type="button" class="btn" id="btnCancel" style="display:none;">ì·¨ì†Œ</button>
            <button type="submit" class="btn primary" id="btnSave" style="display:none;">ì €ì¥</button>
          </div>
        </div>
      </form>

      <div data-pane="security" style="display:none;">
        <p class="meta">ë¹„ë°€ë²ˆí˜¸/2ë‹¨ê³„ ì¸ì¦ì€ ì¶”í›„ ì—°ê²° ì˜ˆì •ì…ë‹ˆë‹¤.</p>
      </div>

      <div data-pane="prefs" style="display:none;">
        <p class="meta">í…Œë§ˆ/ì•Œë¦¼/ì–¸ì–´ ë“± í™˜ê²½ì„¤ì •ì€ ì¶”í›„ ì—°ê²° ì˜ˆì •ì…ë‹ˆë‹¤.</p>
      </div>
    </div>
  </section>
</div>

<script>
  // íƒ­ ì „í™˜
  const tabs = document.querySelectorAll('.tab[role="tab"]');
  const panes = document.querySelectorAll('[data-pane]');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => { x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
    t.classList.add('active'); t.setAttribute('aria-selected','true');
    panes.forEach(p => p.style.display = (p.dataset.pane === t.dataset.tab) ? 'block' : 'none');
  }));

  // í¸ì§‘ í† ê¸€
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');
  const inputs = document.querySelectorAll('#formBasic input');

  function setEditable(on){
    inputs.forEach(i => on ? i.removeAttribute('readonly') : i.setAttribute('readonly','readonly'));
    btnSave.style.display = on ? 'inline-block' : 'none';
    btnCancel.style.display = on ? 'inline-block' : 'none';
    btnEdit.textContent = on ? 'ì½ê¸°' : 'í¸ì§‘';
  }
  btnEdit.addEventListener('click', () => setEditable(btnSave.style.display !== 'inline-block'));
  btnCancel.addEventListener('click', () => location.reload());
  setEditable(false);
</script>
{% endblock %}