{% extends "base.html" %}
{% block title %}í”„ë¡œí•„{% endblock %}
{% block header %}í”„ë¡œí•„{% endblock %}

{% block content %}
<div class="grid-profile">
  <!-- ì¢Œì¸¡: í”„ë¡œí•„ ì¹´ë“œ -->
  <aside class="card">
    <div class="profile-hero">
      <div class="avatar">{{ (user.name[:1] if user and user.name) or "?" }}</div>
      <div class="name">{{ user.name or 'ì´ë¦„ì—†ìŒ' }}</div>
      <div class="handle">@{{ user.username or ('user' ~ user.id) }}</div>
      <div class="role-chip">{{ user.role or 'student' }}</div>
    </div>

    <div class="kv"><span>ğŸ“§</span><span>{{ user.email }}</span></div>
    {% if user.phone %}
    <div class="kv"><span>ğŸ“±</span><span>{{ user.phone }}</span></div>
    {% endif %}
    <div class="kv"><span>ğŸ—“ï¸</span><span>ê°€ì…ì¼: {{ user.created_at|ymd_kr }}</span></div>

    <div class="stats">
      <div>ìˆ˜ê°• ì¤‘ì¸ ê°•ì¢Œ <b>{{ enrolled_cnt }}</b> ê°œ</div>
      <div>ì™„ë£Œí•œ ê³¼ì œ <b>{{ submitted_cnt }}</b> ê°œ</div>
      <div>í‰ê·  ì ìˆ˜ <b>{{ avg_score if avg_score is not none else '-' }}</b></div>
    </div>
  </aside>

  <!-- ìš°ì¸¡: ìƒì„¸/í¸ì§‘ -->
  <section class="card">
    <div class="tabs">
      <a class="tab active" data-tab="basic">ê¸°ë³¸ ì •ë³´</a>
      <a class="tab" data-tab="security">ë³´ì•ˆ</a>
      <a class="tab" data-tab="prefs">í™˜ê²½ì„¤ì •</a>
      <div class="spacer"></div>
      <button id="btnEdit" class="btn">í¸ì§‘</button>
    </div>

    <div class="pad">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="formBasic" method="post" action="{{ url_for('profile_update') }}">
        <div data-pane="basic">
          <div class="row"><label>ì´ë¦„</label><input name="name" value="{{ user.name or '' }}" readonly></div>
          <div class="row"><label>ì´ë©”ì¼</label><input name="email" type="email" value="{{ user.email or '' }}" readonly></div>
          <div class="row"><label>ì „í™”ë²ˆí˜¸</label><input name="phone" value="{{ user.phone or '' }}" placeholder="010-0000-0000" readonly></div>
          <div class="row"><label>ì‚¬ìš©ìëª…(í•¸ë“¤)</label><input name="username" value="{{ user.username or '' }}" placeholder="ì˜ˆ: @young" readonly></div>

          <div class="actions">
            <button type="button" class="btn" id="btnCancel" style="display:none;">ì·¨ì†Œ</button>
            <button type="submit" class="btn primary" id="btnSave" style="display:none;">ì €ì¥</button>
          </div>
        </div>
      </form>

      <div data-pane="security" style="display:none;">
        <p class="meta">ë¹„ë°€ë²ˆí˜¸/2ë‹¨ê³„ ì¸ì¦ì€ ì¶”í›„ ì—°ê²° ì˜ˆì •</p>
      </div>
      <div data-pane="prefs" style="display:none;">
        <p class="meta">í…Œë§ˆ/ì•Œë¦¼/ì–¸ì–´ ë“± í™˜ê²½ì„¤ì •ì€ ì¶”í›„ ì—°ê²° ì˜ˆì •</p>
      </div>
    </div>
  </section>
</div>

<script>
  // íƒ­ ì „í™˜
  const tabs = document.querySelectorAll('.tab');
  const panes = document.querySelectorAll('[data-pane]');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    panes.forEach(p => p.style.display = (p.dataset.pane === t.dataset.tab) ? 'block' : 'none');
  }));

  // í¸ì§‘ í† ê¸€
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');
  const inputs = document.querySelectorAll('#formBasic input');
  function setEditable(on){
    inputs.forEach(i => on ? i.removeAttribute('readonly') : i.setAttribute('readonly','readonly'));
    btnSave.style.display = on ? 'inline-block' : 'none';
    btnCancel.style.display = on ? 'inline-block' : 'none';
    btnEdit.textContent = on ? 'ì½ê¸°' : 'í¸ì§‘';
  }
  btnEdit.addEventListener('click', () => setEditable(btnSave.style.display !== 'inline-block'));
  btnCancel.addEventListener('click', () => location.reload());
  setEditable(false);
</script>
{% endblock %}