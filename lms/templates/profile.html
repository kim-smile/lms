{% extends "base.html" %}
{% block title %}프로필 · LMS{% endblock %}

{% block content %}
<h1 class="page-title">프로필</h1>
<p class="subtitle">내 정보와 통계를 확인하고 수정할 수 있어요.</p>

<div class="grid-profile">
  <!-- 좌측: 프로필 카드 -->
  <aside class="card" aria-labelledby="profile-card-title">
    <h2 class="card-title" id="profile-card-title" style="margin-bottom:.5rem;">내 프로필</h2>

    <div class="profile-hero" aria-label="사용자 기본 정보">
      <div class="avatar">{{ (user.name or '?')|list|first }}</div>
      <div class="name">{{ user.name or '이름없음' }}</div>
      <div class="handle">@{{ user.username or ('user' ~ user.id) }}</div>
      <div class="role-chip">{{ user.role or 'student' }}</div>
    </div>

    <div class="kv" aria-label="이메일"><span>📧</span><span>{{ user.email }}</span></div>
    {% if user.phone %}
    <div class="kv" aria-label="전화번호"><span>📱</span><span>{{ user.phone }}</span></div>
    {% endif %}
    <div class="kv" aria-label="가입일"><span>🗓️</span><span>가입일: {{ user.created_at|ymd_kr }}</span></div>

    <div class="stats">
      <div>수강 중인 강좌 <b>{{ enrolled_cnt }}</b> 개</div>
      <div>완료한 과제 <b>{{ submitted_cnt }}</b> 개</div>
      <div>평균 점수 <b>{{ avg_score if avg_score is not none else '-' }}</b></div>
    </div>
  </aside>

  <!-- 우측: 상세/편집 -->
  <section class="card">
    <div class="tabs" role="tablist" aria-label="프로필 탭">
      <button class="tab active" data-tab="basic" role="tab" aria-selected="true">기본 정보</button>
      <button class="tab" data-tab="security" role="tab" aria-selected="false">보안</button>
      <button class="tab" data-tab="prefs" role="tab" aria-selected="false">환경설정</button>
      <div class="spacer" style="flex:1"></div>
      <button id="btnEdit" class="btn" type="button">편집</button>
    </div>

    <div class="pad">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="formBasic" method="post" action="{{ url_for('profile.update') }}">
        <div data-pane="basic">
          <div class="row">
            <label for="f-name">이름</label>
            <input id="f-name" name="name" value="{{ user.name or '' }}" readonly>
          </div>
          <div class="row">
            <label for="f-email">이메일</label>
            <input id="f-email" name="email" type="email" value="{{ user.email or '' }}" readonly>
          </div>
          <div class="row">
            <label for="f-phone">전화번호</label>
            <input id="f-phone" name="phone" value="{{ user.phone or '' }}" placeholder="010-0000-0000" readonly>
          </div>
          <div class="row">
            <label for="f-username">사용자명(핸들)</label>
            <input id="f-username" name="username" value="{{ user.username or '' }}" placeholder="예: @young" readonly>
          </div>

          <div class="actions">
            <button type="button" class="btn" id="btnCancel" style="display:none;">취소</button>
            <button type="submit" class="btn primary" id="btnSave" style="display:none;">저장</button>
          </div>
        </div>
      </form>

      <div data-pane="security" style="display:none;">
        <p class="meta">비밀번호/2단계 인증은 추후 연결 예정입니다.</p>
      </div>

      <div data-pane="prefs" style="display:none;">
        <p class="meta">테마/알림/언어 등 환경설정은 추후 연결 예정입니다.</p>
      </div>
    </div>
  </section>
</div>

<script>
  // 탭 전환
  const tabs = document.querySelectorAll('.tab[role="tab"]');
  const panes = document.querySelectorAll('[data-pane]');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => { x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
    t.classList.add('active'); t.setAttribute('aria-selected','true');
    panes.forEach(p => p.style.display = (p.dataset.pane === t.dataset.tab) ? 'block' : 'none');
  }));

  // 편집 토글
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');
  const inputs = document.querySelectorAll('#formBasic input');

  function setEditable(on){
    inputs.forEach(i => on ? i.removeAttribute('readonly') : i.setAttribute('readonly','readonly'));
    btnSave.style.display = on ? 'inline-block' : 'none';
    btnCancel.style.display = on ? 'inline-block' : 'none';
    btnEdit.textContent = on ? '읽기' : '편집';
  }
  btnEdit.addEventListener('click', () => setEditable(btnSave.style.display !== 'inline-block'));
  btnCancel.addEventListener('click', () => location.reload());
  setEditable(false);
</script>
{% endblock %}