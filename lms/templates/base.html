<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Learning Management System{% endblock %}</title>

  <!-- Global CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />

  {% block head_extra %}{% endblock %}
</head>
<body>

  <div class="layout" role="application">
    <!-- ========== Sidebar ========== -->
    <aside class="sidebar" aria-label="ì£¼ìš” ë‚´ë¹„ê²Œì´ì…˜">
      <div class="brand" aria-label="ì„œë¹„ìŠ¤ëª…">LMS</div>

      <nav class="sidenav" role="navigation">
        {# Helper: returns 'active' class and sets aria-current for current page #}
        {% macro nav_item(label, endpoint_or_url, is_active, icon) -%}
          <a
            class="nav-item {{ 'active' if is_active else '' }}"
            href="{{ endpoint_or_url }}"
            {% if is_active %} aria-current="page" {% endif %}
          >
            <span class="icon" aria-hidden="true">{{ icon }}</span>
            <span class="label">{{ label }}</span>
          </a>
        {%- endmacro %}

        {{ nav_item('ëŒ€ì‹œë³´ë“œ',
                    url_for('dashboard.home'),
                    active_exact('/'),
                    'ğŸ ') }}

        {{ nav_item('ê°•ì¢Œ',
                    url_for('courses.home'),
                    active_prefix('/courses') or active_prefix('/course'),
                    'ğŸ“š') }}

        {{ nav_item('ë©˜í† ë§',
                    url_for('mentoring.home'),
                    active_prefix('/mentoring'),
                    'ğŸ§‘â€ğŸ«') }}

        {{ nav_item('ì‚¬ìš©ì ê´€ë¦¬',
                    url_for('users.home'),
                    active_prefix('/users'),
                    'ğŸ‘¥') }}

        {{ nav_item('ë¶„ì„ ë° ë¦¬í¬íŠ¸',
                    url_for('analytics.home'),
                    active_prefix('/analytics'),
                    'ğŸ“Š') }}

        {{ nav_item('ë©”ì‹œì§€',
                    url_for('messages.home'),
                    active_prefix('/messages'),
                    'ğŸ’¬') }}

        {{ nav_item('ì¼ì •',
                    url_for('schedule.home'),
                    active_prefix('/schedule'),
                    'ğŸ“…') }}

        {{ nav_item('ê³¼ì œ',
                    url_for('assignments.home'),
                    active_prefix('/assignments'),
                    'ğŸ“') }}

        {{ nav_item('ì„±ì ',
                    url_for('grades.home'),
                    active_prefix('/grades'),
                    'ğŸ…') }}

        {{ nav_item('í”„ë¡œí•„',
                    url_for('profile.home'),
                    active_prefix('/profile'),
                    'ğŸ‘¤') }}

        {{ nav_item('ì„¤ì •',
                    url_for('settings.home'),
                    active_prefix('/settings'),
                    'âš™ï¸') }}
      </nav>

      <!-- ì‚¬ì´ë“œë°”: ë¹ ë¥¸ í†µê³„ & ìµœê·¼ í™œë™ -->
      <section class="sb-widget">
        <div class="sb-title">ë¹ ë¥¸ í†µê³„</div>
        <ul class="sb-kpis">
          <li><span>ìˆ˜ê°• ì¤‘ì¸ ê°•ì¢Œ</span><b>{{ sb_stats.courses }}</b></li>
          <li><span>ì™„ë£Œí•œ ê³¼ì œ</span><b>{{ sb_stats.completed }}</b></li>
          <li><span>í‰ê·  ì ìˆ˜</span>
            <b>
              {% if sb_stats.avg_score is not none %}
                {{ ('%.0f' % sb_stats.avg_score) }}%
              {% else %} â€” {% endif %}
            </b>
          </li>
        </ul>
      </section>

      <section class="sb-widget">
        <div class="sb-title">ìµœê·¼ í™œë™</div>
        <ul class="sb-recent">
          {# services.metrics.recent_activities_for_user ê°€ Message ê°ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜ #}
          {% for m in sb_recent %}
            <li>
              <span class="dot"></span>
              <div class="sr-main">
                <div class="sr-text">
                  {{ m.title or (m.body[:60] ~ ('â€¦' if m.body and m.body|length > 60 else '')) }}
                </div>
                <div class="sr-when muted small">{{ m.created_at|timeago_kr }}</div>
              </div>
            </li>
          {% else %}
            <li class="muted small">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</li>
          {% endfor %}
        </ul>
      </section>
    </aside>

    <!-- ========== Main ========== -->
    <main id="main-content" class="main" tabindex="-1">
      <!-- âœ… ë‹¨ í•˜ë‚˜ì˜ ìƒë‹¨ë°”ë§Œ ìœ ì§€ -->
      <header class="topbar" role="banner">
        <form class="searchbar" role="search" method="get" action="{{ url_for('courses.home') }}">
          <label for="global-search" class="sr-only">ê²€ìƒ‰</label>
          <input
            id="global-search"
            class="search"
            name="q"
            placeholder="ê°•ì¢Œ, ì‚¬ìš©ì, ì½˜í…ì¸  ê²€ìƒ‰â€¦"
            value="{{ request.args.get('q','') }}"
            autocomplete="off"
          />
        </form>

        <div class="user-menu" style="display:flex; align-items:center; gap:12px;">
          <span class="muted small">
            {{ (current_user.name if current_user else 'ê³„ì •') }}
          </span>

          {% if session.get('uid') %}
            <form method="post" action="{{ url_for('auth.logout_post') }}">
              <button type="submit" class="btn-ghost">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
          {% else %}
            <a class="btn-ghost" href="{{ url_for('auth.home') }}">ë¡œê·¸ì¸</a>
          {% endif %}
        </div>
      </header>

      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-stack" role="status" aria-live="polite">
            {% for category, message in messages %}
              <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>
  </div>

  {% block body_scripts %}
  <script>
    // ìµœì†Œí•œì˜ ì ‘ê·¼ì„±/í¸ì˜ ìŠ¤í¬ë¦½íŠ¸
    (function () {
      // í”Œë˜ì‹œ ìë™ ìˆ¨ê¹€
      const flashes = document.querySelectorAll('.flash');
      if (flashes.length) {
        setTimeout(() => flashes.forEach(el => el.classList.add('is-hiding')), 2500);
        setTimeout(() => flashes.forEach(el => el.remove()), 3500);
      }

      // ìœ ì € ë©”ë‰´ í† ê¸€(í•„ìš” ì‹œ í™•ì¥)
      const btn = document.querySelector('.user-btn');
      if (btn) {
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!expanded));
        });
      }
    })();
  </script>
  {% endblock %}
</body>
</html>