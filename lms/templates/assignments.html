{% extends "base.html" %}
{% block title %}과제{% endblock %}
{% block header %}과제{% endblock %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="flash {{ category }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="card">
  <table class="tbl">
    <thead>
      <tr>
        <th>과제</th>
        <th>강좌</th>
        <th>마감</th>
        <th>제출 상태</th>
        <th style="width:360px;">제출/재제출</th>
      </tr>
    </thead>
    <tbody>
    {% for a, c in rows %}
      {% set sub = sub_map.get(a.id) %}
      <tr>
        <td>
          <b>{{ a.title }}</b>
          {% if sub and sub.score is not none %}
            <div class="muted">점수: <b>{{ sub.score }}</b></div>
          {% endif %}
        </td>
        <td class="muted">{{ c.title }}</td>
        <td>
          {% if a.due_at %}<span class="badge">{{ a.due_at|dt_kr }}</span>
          {% else %}-{% endif %}
        </td>
        <td>
          {% if sub and sub.submitted_at %}
            {% if a.due_at and sub.submitted_at > a.due_at %}
              <span class="chip chip-warn">지각 제출</span>
            {% else %}
              <span class="chip chip-ok">제출됨</span>
            {% endif %}
            <div class="muted">{{ sub.submitted_at|dt_kr }}</div>
            {% if sub.file_url %}
              <div><a href="{{ sub.file_url }}" target="_blank">첨부 다운로드</a></div>
            {% endif %}
            {% if sub.comment %}
              <div class="muted">메모: {{ sub.comment }}</div>
            {% endif %}
          {% else %}
            <span class="chip">미제출</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('assignment_submit', aid=a.id) }}" enctype="multipart/form-data" style="display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;">
            <input type="file" name="file" />
            <input name="comment" placeholder="메모(선택)" />
            <button class="btn">업로드</button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="muted">표시할 과제가 없습니다.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}