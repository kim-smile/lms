{% extends "base.html" %}
{% block title %}분석 및 리포트 · LMS{% endblock %}

{% block content %}
  <h1 class="page-title">분석 및 리포트</h1>
  <p class="subtitle">학습 데이터를 분석하고 인사이트를 확인하세요.</p>

  <!-- KPI 요약 -->
  <div class="grid grid-4 kpi-row">
    <section class="card kpi" aria-label="총 학생 수">
      <div class="kpi-value">{{ metrics.student_count }}</div>
      <div class="kpi-label">총 학생 수</div>
      <div class="kpi-sub">{{ metrics.student_growth }} 전월 대비</div>
    </section>
    <section class="card kpi" aria-label="활성 강좌">
      <div class="kpi-value">{{ metrics.active_courses }}</div>
      <div class="kpi-label">활성 강좌</div>
      <div class="kpi-sub">{{ metrics.new_courses }} 신규 강좌</div>
    </section>
    <section class="card kpi" aria-label="평균 진도율">
      <div class="kpi-value">{{ metrics.avg_progress }}%</div>
      <div class="kpi-label">평균 진도율</div>
      <div class="kpi-sub">{{ metrics.progress_growth }} 전월 대비</div>
    </section>
    <section class="card kpi" aria-label="완료율">
      <div class="kpi-value">{{ metrics.completion_rate }}%</div>
      <div class="kpi-label">완료율</div>
      <div class="kpi-sub">{{ metrics.completion_growth }} 전월 대비</div>
    </section>
  </div>

  <!-- 차트 -->
  <div class="grid grid-2">
    <section class="card">
      <div class="card-title">강좌별 성과</div>
      <p class="muted small">각 강좌의 학생 수와 완료 학생 수</p>
      <div role="region" aria-label="강좌별 성과 차트">
        <canvas id="courseChart"></canvas>
        {% if not course_perf or course_perf|length == 0 %}
          <p class="muted small">표시할 데이터가 없습니다.</p>
        {% endif %}
      </div>
    </section>

    <section class="card">
      <div class="card-title">학습 진도 추이</div>
      <p class="muted small">월별 평균 진도율과 과제 제출 수</p>
      <div role="region" aria-label="학습 진도 추이 차트">
        <canvas id="trendChart"></canvas>
        {% if not trend or trend|length == 0 %}
          <p class="muted small">표시할 데이터가 없습니다.</p>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- 강좌별 상세 분석 -->
  <section class="card">
    <div class="card-title">강좌별 상세 분석</div>
    <p class="muted small">각 강좌의 세부 성과 지표를 확인하세요.</p>

    {% if course_details and course_details|length %}
      {% for c in course_details %}
        <div class="row-item" style="display:flex;align-items:center;justify-content:space-between;padding:16px;border:1px solid var(--border);border-radius:12px;margin:10px 0;background:#fff">
          <div class="row-left" style="flex:1 1 auto;">
            <div class="row-title" style="font-weight:600;margin-bottom:6px">{{ c.title }}</div>
            <div class="row-sub muted small">
              학생: {{ c.students }}명 · 평균 점수: {{ c.avg_score if c.avg_score is not none else '—' }}점
            </div>
          </div>
          <div class="row-right" style="text-align:right;min-width:260px">
            <div class="muted small" style="margin-bottom:6px">완료율</div>
            <div class="bar" style="height:8px;">
              <span style="width: '{{ (c.completion or 0)|int }}%'"></span>
            </div>
            <div class="pct">{{ c.completion }}%</div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="muted">표시할 강좌가 없습니다.</div>
    {% endif %}
  </section>

  <!-- 위험군 학생 조기 경고 -->
  <section class="card">
    <div class="card-title">⚠️ 위험군 학생 조기 경고</div>
    <p class="muted small">학습 부진이 우려되는 학생들을 확인하고 지원하세요.</p>

    {% if risk_students and risk_students|length %}
      {% for s in risk_students %}
        <div class="risk-item" style="display:flex;justify-content:space-between;align-items:flex-start;padding:16px;border:1px solid #ffe6c7;background:#fff9f2;border-radius:12px;margin:10px 0">
          <div class="risk-main">
            <div class="risk-name" style="font-weight:600;margin-bottom:4px">{{ s.name }}</div>
            <div class="risk-email muted small">{{ s.email }}</div>
            <div class="chips" style="margin-top:8px">
              {% for b in s.badges %}
                <span class="chip" style="display:inline-block;padding:4px 10px;font-size:12px;border-radius:9999px;background:#f3f4f6;color:#374151;margin-right:6px">{{ b }}</span>
              {% endfor %}
            </div>
          </div>
          <div class="risk-metrics muted small" style="text-align:right">
            <div>진도: <b>{{ s.progress }}%</b></div>
            <div>점수: <b>{{ s.avg_score if s.avg_score is not none else '—' }}점</b></div>
            <div>제출률: <b>{{ s.submission_rate }}%</b></div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="muted">위험군 학생이 없습니다.</div>
    {% endif %}
  </section>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // 안전한 직렬화
    const coursePerf = JSON.parse('{{ course_perf | default([]) | tojson | replace("</","<\\/") | safe }}');
    const trendData  = JSON.parse('{{ trend       | default([]) | tojson | replace("</","<\\/") | safe }}');

    // 강좌별 성과 차트
    (function () {
      const el = document.getElementById('courseChart');
      if (!el || !Array.isArray(coursePerf) || coursePerf.length === 0) return;

      new Chart(el, {
        type: 'bar',
        data: {
          labels: coursePerf.map(d => d.title),
          datasets: [
            { label: '수강생 수', data: coursePerf.map(d => d.enrolled), backgroundColor: '#6366f1' },
            { label: '완료 학생 수', data: coursePerf.map(d => d.completed), backgroundColor: '#10b981' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    })();

    // 학습 진도 추이 차트
    (function () {
      const el = document.getElementById('trendChart');
      if (!el || !Array.isArray(trendData) || trendData.length === 0) return;

      new Chart(el, {
        type: 'line',
        data: {
          labels: trendData.map(d => d.month),
          datasets: [
            { label: '평균 진도율(%)', data: trendData.map(d => d.avg_progress), borderColor: '#10b981', fill: false, tension: 0.35 },
            { label: '과제 제출 수',   data: trendData.map(d => d.submissions), borderColor: '#6366f1', fill: false, tension: 0.35 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    })();
  </script>
{% endblock %}